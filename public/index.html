<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US. food waste</title>
    <script type="text/javascript" src="d3.js"></script>
    <script type="text/javascript" src="main2.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@500;700&display=swap" rel="stylesheet">
    <div id="my_dataviz"></div>
</head>
<body>
<div class="intro">
    <h1>US. FOOD WASTE </h1>
    <h2>Explore the data!</h2>
    <h3>The US. is wasting <span style="color: rgb(255,125,0)"> A LOT</span> of their food-supply - It is a problem throughout most of the supplychain <br> Join us, while we dive deeper into the numbers</h3>
</div>

<div id="grid">
    <div class="barchart"></div>
    <div class="barchartText">
        <p1><span style="color: rgb(255,125,0)">How</span> is food waste distributed across the various sectors in the US.? </p1>
    </div>
    </div>
    <div id="grid2">
<div class="spiralText">
    <p1>The US. food waste leaves behind a <span style="color: rgb(255,125,0)">massive CO2 footprint.</span>
      The major threat from increased CO2 is the greenhouse effect. 
      As a greenhouse gas, excessive CO2 creates a cover that traps the sun´s heat energy in the atmospheric bubble, 
      warming the planet and the oceans.</p1>
</div>
<div class="spiral"></div>
</div>
<div id="grid3">
  <div class="treemap"></div>
  <div class="treemapText">
    <p1>Main causes of food waste in the residential sector in 2019.<br><br> 
      <span style="font-weight: bold">What can <span style="color: rgb(255,125,0)">YOU</span> do to change your habbits?</span></p1>
  </div>
</div>
<footer>
    <p>MADE BY: HVER-GUDERNE
    <a class="ref" href="https://refed.com/">DATAKILDE</a>
    <b>© 2021 HVER-GUDERNE A/S</b></p>
  </footer>

    <script>
// højde og bredde på mit svg element
const w = 800;
const h = 622.22;
const rad = h*0.33;
const pi = Math.PI;
function convertXPlacement(degree){return w/2 + rad * Math.cos(degree*0.0174532925)}
function convertYPlacement(degree){return h/2 + rad * Math.sin(degree*0.0174532925)}
// værdier jeg skal bruge til boblernes størrelse og placering
const xplacement = [convertXPlacement(300), convertXPlacement(320), convertXPlacement(350), convertXPlacement(25), convertXPlacement(72), convertXPlacement(130), convertXPlacement(190), convertXPlacement(260)]
const yplacement = [convertYPlacement(300), convertYPlacement(320), convertYPlacement(350), convertYPlacement(25), convertYPlacement(72), convertYPlacement(130), convertYPlacement(190), convertYPlacement(260)] 

//jeg kan ikke finde ud af at loope igennem key value pair så det skal jeg lige fikse, her er et array med tallene i + navnene på fx firmaerne
let co2arr = [1100000, 5240000, 15000000, 35500000, 60640000, 104000000, 126158000, 168700000]
let co2names = ["LEGO", "Coca-Cola", "Samsung", "Maersk", "Amazon","US ARMY x2", "Scandinavia", "US Foodwaste"]
let funfacts = [
  "Fun fact:@her er en fun fact",
  "Fun fact:@her er en fun fact",
  "Fun fact:@her er en fun fact",
  "Fun fact:@her er en fun fact",
  "Fun fact:@her er en fun fact",
  "Fun fact:@her er en fun fact",
  "Fun fact:@her er en fun fact",
  "Fun fact:@her er en fun fact"
]
//lav en svg boks til boblerne og en scale til mine radiusser, min range er lidt åndsvag fordi jeg ikke skal bruge radius men areal. kan måske godt se der er noget galt
const rScale = d3.scaleLinear()
        .domain([0, 168700000])
        .range([0, 24000]);
const svg = d3.select(".spiral")
        .append("svg")
        .attr("width", w)
        .attr("height", h)

//svg boks til barcharten

const svg2 = d3.select(".barchart")
        .append("svg")
        .attr("width", 750)
        .attr("height", 400)

// To g bokse
        var box1 = svg2.append('g')
        var box2 = svg2.append('g')

// Grå firkant og tekst.
        box1.append("rect")
          .attr('x', 650)
          .attr('y', 38)
          .attr("width", 15)
          .attr("height", 15)
          .attr('stroke', 'white')
          .attr('fill', "rgb(128,128,128)")

        box1.append('text')
          .attr('x', 675)
          .attr('y', 50)
          .text("Tons supply")
          .style("fill", "white")
          .style("font-family", "monospace")
          .attr("font-size", "11px")
 
// Orange firkant og tekst.
        box2.append('rect')
          .attr('x', 650)
          .attr('y', 68)
          .attr("width", 15)
          .attr("height", 15)
          .attr('stroke', 'white')
          .attr('fill', "rgb(255,125,0)")

        box2.append('text')
          .attr('x', 675)
          .attr('y', 80)
          .text("Tons wasted")
          .style("fill", "white")
          .style("font-family", "monospace")
          .attr("font-size", "11px")
       
// set the width, height and margins of the graph
const width = 740;
const height = 700;

// append the svg object to the page
const svg3 = d3.select(".treemap")
.append("svg")
  .attr("width", width)
  .attr("height", height)    

//prøver at lave et par layers
let layer1 = svg.append('g')
let layer2 = svg.append('g')
let layer3 = svg.append('g')
let invis = layer1.append("svg").attr("opacity",100).attr("x", 138).attr("y", 94).attr("width", w*0.61).attr("height", h*0.71).attr("id", "boks");

//nu laver jeg lige de orange cirkler
layer2.selectAll("circle")
    .data(co2arr)
    .enter()
    .append("circle")
    .attr("cx", function(d, i){
        return xplacement[i]
    } ) 
    .attr("cy", function(d, i){
        return yplacement[i]
    } )
    .attr("r", 5)
    .attr("fill", function(d, i){
      let r = 144
      let g = 90
      let b = 90
      return 'rgb(' + (r+4*i) + ','+(g-8*i)+',' + (b-8*i) + ')'
    })
    .attr("class", "circles")
    .on('mouseover', function (d, i) {
     d3.select(this).transition("mouseover")
          .duration('5')
          .attr("opacity", 1)
          .attr("fill", function(d){
      let r = 134
      let g = 80
      let b = 80
      return 'rgb(' + (r+4*i) + ','+(g-8*i)+',' + (b-8*i) + ')'
    })
          .style("cursor", "pointer")
        })
          .style("cursor", "pointer")
    .on('mouseout', function (d, i) {
     d3.select(this).transition("mouseout")
          .duration('5')
          .attr("opacity", 1)
          .attr("fill", function(d){
      let r = 144
      let g = 90
      let b = 90
      return 'rgb(' + (r+4*i) + ','+(g-8*i)+',' + (b-8*i) + ')'
    })
          .style('cursor', 'default')        
        })
    .on("click", function(d, i){
      let zoom = d3.zoom()
  .on('zoom', handleZoom);

  function handleZoom(e) {
  d3.selectAll('.spiral g')
    .attr('transform', e.transform);};
if(control === 0){
  control=10;
  d3.select('.spiral').transition("overallzoom").duration("200").call(zoom.scaleTo, 9);

d3.select(this).transition("cirkel_position").duration('200')
      .attr("cx", w*0.5)
      .attr("cy", h*0.5)
      .attr("r", 29);

      layer3.selectAll('funfacts').data(co2names).enter().append('text')
      .text(function(d){return co2names[i-1] +" emmits " + co2arr[i-1] + " tons CO2"})
      .attr('x', w*0.5)
      .attr('y', h*0.5-8)
      .attr('text-anchor', 'middle')
      .style('font-size', 2.4)
      .attr('fill', 'white')
      .attr("font-family", "'Source Code Pro', monospace")
      .attr('class', 'funfacts');


      layer3.selectAll('.funfacts1').data(funfacts).enter().append('text')
      .text('FUN FACT!')
      .attr('x', w*0.5)
      .attr('y', h*0.5)
      .attr('text-anchor', 'middle')
      .style('font-size', 3)
      .attr('fill', 'white')
      .attr("font-family", "'Source Code Pro', monospace") 
      .attr('class', 'funfacts'); 


      layer3.selectAll('.funfacts2').data(funfacts).enter().append('text')
      .text(function(d){return funfacts[i-1]})
      .attr('x', w*0.5)
      .attr('y', h*0.5+3)
      .attr('text-anchor', 'middle')
      .style('font-size', 2)
      .attr('fill', 'white')
      .attr("font-family", "'Source Code Pro', monospace")
      .attr('class', 'funfacts')
      .style('opacity', 1);
 
      }


      else if(control === 10){
        d3.select('.spiral').transition().duration(500).call(zoom.scaleTo, 1);

d3.select(this).transition("rewinder").duration('500')
    .attr("cx", function(d){
        return xplacement[i-1]
    } ) 
    .attr("cy", function(d){
        return yplacement[i-1]
    } )
    .attr("r", function(d){
                return optarr[i-1]});
  layer3.selectAll('.funfacts').remove()
    control = 0
      }


    });
let control = 0


//nu laver jeg lige nogle små nameplates til mine cirkler
    layer2.selectAll("text")
        .data(co2names)
        .enter()
        .append("text")
        .attr("x", function(d, i){
            if(i < 2){ return xplacement[i] + 10 + (i*12)}
            else if (i < 3){ return xplacement[i] + (i*16)}
            else if (i < 5){ return xplacement[i] + (i*16)}
            else if (i < 6){ return xplacement[i] - (i*34)}
            else if (i < 7){ return xplacement[i] - (i*31)}
            else if (i < 8){ return xplacement[i] - (i*30)}
        })
        .attr("y", function(d, i){
            return yplacement[i]
        })
        .text(function(d){return d})
        .attr("fill", "white")
        .attr("font-family", "'Source Code Pro', monospace")
        .style("text-decoration", "underline")

        //og nu tekst som overskrift
        layer2.append("text")
        .text("CO2 footprint/year")
        .attr("x", 500)
        .attr("y", 80)
        .style("font-size", "24px")
        .attr("fill", "rgb(128,128,128)")
        .style("font-weight", "bold")
        .attr("font-family", "'Source Code Pro', monospace")

// her laver jeg animationen der sker når man ruller ned på siden
        let optarr = []
        for(let i = 0; i < 8; i++){
            optarr.push(Math.sqrt(rScale(co2arr[i])/pi))
        }
        console.log(optarr)
        let hej = 0
        // okay nu prøver vi at lave en transistion der gør noget når jeg har scrolled ned på siden. vil gøre boblerne store når vi rammer en hvis mængde pixels fra toppen
        function scrolldown(){
          if(hej === 0){
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 110){
              hej = 1;
            layer2.selectAll("circle")
                .data([1,2,3,4,5,6,7,8])
                .transition()
                .ease(d3.easeElasticOut.amplitude(0.1).period(0.5))
                .duration(1000)
                .attr("r", function(d, i){
                return optarr[i]
            })
                .delay(function(i){return (i*120)})
                
                ;
                
               
}
          }
};
        //nu skal jeg have en eventhandler der kan trigger min function
       /* let count = 0
        if(count == 0){window.onscroll = function() {scrolldown()};}*/
        window.onscroll = function() {scrolldown()};


        //Barchart

    
    const bw = 700;
    const bh = 400;
    const barPadding = 80;
    const yPadding = 5;
    const padding = 40;
    const paddingLeft = 30;

    // Query kører op imod API'en som findes i 'main.js'.
    // HTML åbnes igennem serveren for at virke.
    d3.json("/foodbarchart", {
      method: "GET", 
    }).then(function(response) {
      const data = response.data; // Hent data ud af response
      console.log("data", data[0]);

      //Tons supply bliver fundet i data
      let supplyArray = [];
      for (let i = 0; i < data.length; i++) {
        supplyArray.push(data[i].supply);
      }

      //Tons waste bliver fundet i data
      let wasteArray = [];
    for (let i = 0; i < data.length; i++) {
      wasteArray.push(data[i].tons_wasted);
    }

      //Sektor bliver fundet i data
    let textArray = []
     for (let i = 0; i < data.length; i++) {
      textArray.push(data[i].sector);
    }

    //Procent waste bliver fundet i data
    let procentWasteArray = []
for (let i = 0; i < data.length; i++) {
  procentWasteArray.push(data[i].procent_wasted);
}

//Al data bliver samlet med rigtige værdier
     let newArray = []
    for (let i = 0; i < supplyArray.length; i++) {
      newArray.push([supplyArray[i],wasteArray[i],textArray[i],procentWasteArray[i]]);
    }

    //Tooltip til visning af procent
    const tooltip = d3.select("#my_dataviz")
    .append("div")
    .style("position", "absolute")
    .style("visibility", "hidden")
    .style("color", "white")
    .style("background-color", "rgb(46, 46, 46)")
    .style("padding", '5px')
    .style("border", "solid")
    .style("border-width", '1px')
    .style("border-color", "white")
    .style("font-family", "monospace")
    .style("font-size", "12px")
    .text("");

// Håndterer mouseover
    function handleMouseover (d, i) {
     d3.select(this).style("fill", "rgb(230,90,0)")
     const procentWaste = i[3]
     tooltip.text("Procent wasted - " + procentWaste.toFixed(2) + "%")
     var x1 = event.clientX;
     var y1 = event.clientY;
     tooltip.style("left", (window.pageXOffset + x1 + 10) + "px")
     tooltip.style("top", (window.pageYOffset + y1 + 10) + "px")
     return tooltip.style("visibility", "visible")
    };
    
//Håndterer mouseout
    function handleMouseout(d, i){
      d3.select(this).style("fill", "rgb(255,125,0)");
      return tooltip.style("visibility", "hidden")
    }

  //TODO
    let xScale = d3.scaleLinear()
    .domain(0, supplyArray.length)
    .range([padding+30,bw - padding]);
// de to lidt magiske tal kan rettes
    let yScale = d3.scaleLinear()
    .domain([0,d3.max(supplyArray)])
    .range([padding ,bh - padding-19]);

    let nyyScale = d3.scaleLinear()
    .domain([d3.max(supplyArray)/1000000 + 19, 0])
    .range([padding,bh - padding]);
    
//de her paddings er midlertidge
    let barXScale = d3.scaleLinear()
    .domain([0,supplyArray.length])
    .range([padding + 55, bw - padding + 35]);

        //laver layers
        let layer1b = svg2.append('g')
        let layer2b = svg2.append('g')
        let layer3b = svg2.append('g')

      // Create bars for supply(grey)
      layer1b.selectAll("rect")
      .data(newArray)
      .enter()
      .append("rect")
      .attr("x",function(d, i){
        return barXScale(i);
      })
      .attr("y", bh-padding)
      .attr("width", bw / wasteArray.length - barPadding)
      .attr("height", 0)
      .attr("fill", "rgb(128,128,128)");

      layer1b.selectAll("rect")
          .data(newArray)
          .transition()
          .ease(d3.easeExpOut)
          .duration(5000)
          .attr("y", function(d){
        return bh - yScale(d[0]);
      })
          .attr("height", function(d) { return yScale(d[0])- padding
      } ) 

      // Create bars for tons_wasted(orange)
      layer2b.selectAll("rect")
      .data(newArray)
      .enter()
      .append("rect")
      .attr("x",function(d, i){
        return barXScale(i);
      })
      .attr("y", bh-padding)
      .attr("width", bw / wasteArray.length - barPadding)
      .attr("height", 0)
      .attr("fill", "rgb(255,125,0)")
      .on("mouseover", handleMouseover)  
      .on("mouseout", handleMouseout)
      
      layer2b.selectAll("rect")
          .data(newArray)
          .transition()
          .delay(1500)
          .ease(d3.easeExpOut)
          .duration(5000)
          .attr("y", function(d){
        return bh - yScale(d[1]);
      })
          .attr("height", function(d) { return yScale(d[1])- padding
      } )
      

      // create sector name
      layer3b.selectAll("text")
      .data(newArray)
      .enter()
      .append("text")
      .text(function(d){
        return d[2];
      })
      .attr("x", function(d,i){
        return barXScale(i) +30
      })
      .attr("y", bh - 20)
      .style("font-family", "monospace")
      .attr("font-size", "12px")
      .attr("fill", "white")
      .attr("text-anchor", "middle");

      // Create xAxis
      const xAxis = d3.axisBottom().scale(xScale);
      svg2.append("g")
         .attr("class", "axis")
         .attr("transform", "translate(0, " + (bh - padding) + ")")
         .call(xAxis)
         .append("text")
         .attr("text-anchor", "middle")
         .attr("fill", "white")
         .attr("transform", `translate(${bw}, 8)`)
         .text("Sector")
         .style("font-family", "monospace");
         
      // Create yAxis
      yAxis = d3.axisLeft().scale(nyyScale).tickValues([0,50, 100, 150, 200, 250, 300, 350]);
      svg2.append("g")
         .attr("class", "axis")
         .attr("transform", "translate(" + 70 + ",0)")
         .call(yAxis)
         .append("text")
         //.attr("text-anchor", "start")
         .attr("x", 115)
         .attr("y", 0)
         .attr("fill", "white")
         .attr("transform", "translate(-70, 28)")
         .text("Million Tons")
         .style("font-family", "monospace");

  // Treemap
let layer1t = svg3.append('g')
let layer2t = svg3.append('g') 

// defines the tooltip   
const tooltip2 = d3.select("#my_dataviz")
.append("div")
.style("position", "absolute")
.style("visibility", "hidden")
.style("color", "white")
.style("background-color", "rgb(46, 46, 46)")
.style("padding", '5px')
.style("border", "solid")
.style("border-width", '1px')
.style("border-color", "white")
.style("font-family", "monospace")
.style("font-size", "12px")
.style("white-space", "pre-line")
.text("");

// handles what happens on mousemove
function handleMousemoveRect (event, d){
  const name = d.data.name;
  const tons = d.data.tons;
  const procent = d.data.procent;
  const text = `${name}\n ${tons} - ${procent}%`
  d3.select(this).style("fill", "rgb(255,105,30)")
  tooltip2.text(text)
  var x = event.clientX;
  var y = event.clientY;
  tooltip2.style("left", (window.pageXOffset + x + 10) + "px")
  tooltip2.style("top", (window.pageYOffset + y + 10) + "px")
  return tooltip2.style("visibility", "visible")
}

// handles what happens on mouseout
function handleMouseoutRect(){
  d3.select(this).style("fill", "rgb(255,125,0)")
  return tooltip2.style("visibility", "hidden")
}

function handleMousemoveText (event, d){
  const name = d.data.name;
  const tons = d.data.tons;
  const procent = d.data.procent;
  const text = `${name}\n ${tons} - ${procent}%`
  tooltip2.text(text)
  var x = event.clientX;
  var y = event.clientY;
  tooltip2.style("left", (window.pageXOffset + x + 10) + "px")
  tooltip2.style("top", (window.pageYOffset + y + 10) + "px")
  d3.select(this).style("cursor", "default")
  return tooltip2.style("visibility", "visible")
}

// handles what happens on mouseout
function handleMouseoutText(){
  return tooltip2.style("visibility", "hidden")
}

// read json data
d3.json("causes.json").then(function(data) {

  // here the size of each leave is given in the 'procent' 
  const root = d3.hierarchy(data).sum(function(d){ 
    return d.procent
  }) 

  // Then d3.treemap computes the position of each element of the hierarchy
  d3.treemap()
    .size([width, height])
    .padding(5)
    (root)

  // use this information to add rectangles:
  layer1t
    .selectAll("rect")
    .data(root.leaves())
    .enter()
    .append("rect")
      .attr('x', function (d) { return d.x0; })
      .attr('y', function (d) { return d.y0; })
      .attr('width', function (d) { return d.x1 - d.x0; })
      .attr('height', function (d) { return d.y1 - d.y0; })
      .style("fill", "rgb(255,125,0)")
      .on("mousemove", handleMousemoveRect)
      .on("mouseout", handleMouseoutRect)

  // and to add the text labels
  layer2t
    .selectAll("text")
    .data(root.leaves())
    .enter()
    .append("text")
    .attr("x", function(d) { return d.x0 + 5})
    .attr("y", function(d) { return d.y0 + 20})   
    .text(function(d) { return d.data.name})
    .attr("text-overflow", "ellipsis")    
    .attr("font-size", "12px")
    .attr("fill", "white")
    .attr("font-weight", "bold")
    .style("font-family", "monospace") 
    .on("mousemove", handleMousemoveText)
    .on("mouseout", handleMouseoutText)
})
})
            
    </script>

</body>
</html>